<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>yuki bbs</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="example4"><h1>掲示板</h1></div>
新規さんへ、先ずは挨拶をしましょう。シード値は自分のidを決めるものでパスワードのようなものです。<br>
今の話題に勇気を出して参加してみましょう!!!<br>
メッセージが送れない場合はメッセージや名前が規制されている可能性があります。<br>
現在の推定オンライン数は不明です。<br>

<h3 id="currentTopic">今の話題：<font color="red">読み込み中...</font></h3>
<form id="topicForm">
    <label for="newTopic">トピック変更: </label>
    <input type="text" id="newTopic" name="newTopic" maxlength="50" required />
    <label for="adminPassForTopic"> 管理者シード (任意): </label>
    <input type="password" id="adminPassForTopic" name="adminPassForTopic" />
    <button type="submit">トピック変更</button>
    <p><small>※最近投稿したシードが管理者の場合、シードの再入力は不要です。</small></p>
</form>
<hr>

<select>
<option>雑談</option>
</select><br>

<form id="postForm">
    <label for="message">メッセージ </label>
    <textarea
        name="message"
        rows="6"
        cols="100"
        maxlength="100"
        id="msg"
        required
    ></textarea><br><br>
    <label for="name">名前 </label>
    <input
        type="text"
        id="name"
        name="name"
        value=""
        maxlength="25"
        required
    />
    <label for="seed"> シード </label>
    <input type="password" id="seed" name="seed" value="" required />
    <button type="submit" id="submit">送信する</button>
</form>

<br>
スピーカー以上のメッセージのみ表示<input type="checkbox"><br>

<h2>投稿</h2>
<table border="1">
    <thead>
        <tr><th>No</th>    <th>名前</th>    <th>投稿</th>    <th>時間</th></tr>
    </thead>
    <tbody id="postsTableBody">
    </tbody>
</table>

<script>
    const postForm = document.getElementById('postForm');
    const messageInput = document.getElementById('msg');
    const nameInput = document.getElementById('name');
    const seedInput = document.getElementById('seed');
    const postsTableBody = document.getElementById('postsTableBody');
    const currentTopicDisplay = document.getElementById('currentTopic');
    const topicForm = document.getElementById('topicForm');
    const newTopicInput = document.getElementById('newTopic');
    const adminPassForTopicInput = document.getElementById('adminPassForTopic');

    function addPostToTable(post, index) {
        const postNo = index + 1; // 投稿番号は表示用に1から始める
        const newRow = postsTableBody.insertRow();

        newRow.innerHTML = `
            <td>${postNo}</td>
            <td><font color="${post.nameColor || 'black'}">${escapeHtml(post.name)}</font><font color="darkorange">${escapeHtml(post.id)}</font></td>
            <td>${escapeHtml(post.content)}</td>
            <td>${escapeHtml(post.time)}</td>
        `;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    async function loadPosts() {
        try {
            const response = await fetch('/api');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            currentTopicDisplay.innerHTML = `今の話題：<font color="red">${escapeHtml(data.topic)}</font>`;

            postsTableBody.innerHTML = '';
            data.posts.forEach((post, index) => {
                addPostToTable(post, index);
            });
        } catch (error) {
            console.error('掲示板データの読み込み中にエラーが発生しました:', error);
            postsTableBody.innerHTML = '<tr><td colspan="4">投稿の読み込みに失敗しました。</td></tr>';
        }
    }

    // 投稿フォームの送信イベントリスナー
    postForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const message = messageInput.value;
        const name = nameInput.value;
        const seed = seedInput.value;

        if (!message || !name || !seed) {
            alert('メッセージ、名前、シードは必須です。');
            return;
        }

        try {
            const response = await fetch('/api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: name, pass: seed, content: message }),
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                messageInput.value = ''; // 投稿成功後、メッセージフィールドをクリア
                await loadPosts(); // 投稿リストを再読み込み
            } else {
                alert('投稿に失敗しました: ' + result.error);
            }
        } catch (error) {
            console.error('投稿中にエラーが発生しました:', error);
            alert('投稿中にエラーが発生しました。ネットワーク接続を確認してください。');
        }
    });

    // トピック変更フォームの送信イベントリスナー
    topicForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const newTopic = newTopicInput.value;
        const adminSeed = adminPassForTopicInput.value;

        if (!newTopic) { // トピックは必須
            alert('新しいトピックは必須です。');
            return;
        }

        try {
            const bodyData = { topic: newTopic };
            if (adminSeed) { // adminSeed が入力されていればbodyに含める
                bodyData.pass = adminSeed;
            }

            const response = await fetch('/topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(bodyData),
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                newTopicInput.value = '';
                adminPassForTopicInput.value = ''; // 入力されていてもクリア
                await loadPosts();
            } else {
                alert('トピックの変更に失敗しました: ' + result.error);
            }
        } catch (error) {
            console.error('トピック変更中にエラーが発生しました:', error);
            alert('トピック変更中にエラーが発生しました。ネットワーク接続を確認してください。');
        }
    });

    document.addEventListener('DOMContentLoaded', loadPosts);
</script>
</body>
</html>
