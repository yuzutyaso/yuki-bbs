<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>yuki bbs</title>
<link rel="stylesheet" href="style.css"> </head>
<body>
<div class="example4"><h1>掲示板</h1></div>
新規さんへ、先ずは挨拶をしましょう。シード値は自分のidを決めるものでパスワードのようなものです。<br>
今の話題に勇気を出して参加してみましょう!!!<br>
メッセージが送れない場合はメッセージや名前が規制されている可能性があります。<br>
現在の推定オンライン数は不明です。<br>

<h3 id="currentTopic">今の話題：<font color="red">読み込み中...</font></h3>
<form id="topicForm">
    <label for="newTopic">トピック変更: </label>
    <input type="text" id="newTopic" name="newTopic" maxlength="50" required />
    <label for="adminPassForTopic"> 管理者シード: </label>
    <input type="password" id="adminPassForTopic" name="adminPassForTopic" required />
    <button type="submit">トピック変更</button>
</form>
<hr>

<select>
<option>雑談</option>
<option>バトルスタジアム</option>
</select><br>

<form id="postForm">
    <label for="message">メッセージ </label>
    <textarea
        name="message"
        rows="6"
        cols="100"
        maxlength="100"
        id="msg"
        required
    ></textarea><br><br>
    <label for="name">名前 </label>
    <input
        type="text"
        id="name"
        name="name"
        value=""
        maxlength="25"
        required
    />
    <label for="seed"> シード </label>
    <input type="password" id="seed" name="seed" value="" required /> <button type="submit" id="submit">送信する</button>
</form>

<br>
スピーカー以上のメッセージのみ表示<input type="checkbox"><br>

<h2>投稿</h2>
<table border="1">
    <thead>
        <tr><th>No</th>    <th>名前</th>    <th>投稿</th>    <th>時間</th></tr>
    </thead>
    <tbody id="postsTableBody">
        </tbody>
</table>

<script>
    const postForm = document.getElementById('postForm');
    const messageInput = document.getElementById('msg');
    const nameInput = document.getElementById('name');
    const seedInput = document.getElementById('seed');
    const postsTableBody = document.getElementById('postsTableBody');
    const currentTopicDisplay = document.getElementById('currentTopic');
    const topicForm = document.getElementById('topicForm');
    const newTopicInput = document.getElementById('newTopic');
    const adminPassForTopicInput = document.getElementById('adminPassForTopic');

    // 投稿をテーブルに追加する関数
    // サーバーから取得したデータ形式に合わせて表示を調整
    function addPostToTable(post, index) {
        // 新しい投稿は配列の先頭に追加されるので、表示順を考慮してNoを逆算するか、
        // サーバーから正確なNoを受け取るのが理想的です。
        // ここでは便宜的に、表示順のインデックスを利用してNoを付与します。
        const postNo = index + 1; // 0から始まるインデックスなので+1
        const newRow = postsTableBody.insertRow(); // 最後に追加 (appendChildのイメージ)
        // または postsTableBody.insertRow(0); で常に一番上に追加することも可能。
        // ただし、その場合は `loadPosts` で reverse() をしない方が自然。

        newRow.innerHTML = `
            <td>${postNo}</td>
            <td><font color="${post.nameColor || 'black'}">${escapeHtml(post.name)}</font><font color="darkorange">${escapeHtml(post.id)}</font></td>
            <td>${escapeHtml(post.content)}</td>
            <td>${escapeHtml(post.time)}</td>
        `;
    }

    // HTMLエスケープ関数 (XSS対策の第一歩)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    // 掲示板データをロードして表示する関数
    async function loadPosts() {
        try {
            const response = await fetch('/api');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // トピックの表示を更新
            currentTopicDisplay.innerHTML = `今の話題：<font color="red">${escapeHtml(data.topic)}</font>`;

            // 投稿をクリアして再描画
            postsTableBody.innerHTML = '';
            // 投稿は新しいものが先頭にあるので、そのままループして追加していく
            data.posts.forEach((post, index) => {
                addPostToTable(post, index);
            });
        } catch (error) {
            console.error('掲示板データの読み込み中にエラーが発生しました:', error);
            postsTableBody.innerHTML = '<tr><td colspan="4">投稿の読み込みに失敗しました。</td></tr>';
        }
    }

    // 投稿フォームの送信イベントリスナー
    postForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // フォームのデフォルト送信を防ぐ

        const message = messageInput.value;
        const name = nameInput.value;
        const seed = seedInput.value;

        if (!message || !name || !seed) {
            alert('メッセージ、名前、シードは必須です。');
            return;
        }

        try {
            const response = await fetch('/api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', // JSON形式で送信
                },
                body: JSON.stringify({ name: name, pass: seed, content: message }),
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                messageInput.value = ''; // メッセージ入力欄をクリア
                // シードは保持するか、クリアするかは要件次第
                // seedInput.value = '';
                // 投稿成功後、掲示板を再読み込みして最新の状態にする
                await loadPosts();
            } else {
                alert('投稿に失敗しました: ' + result.error);
            }
        } catch (error) {
            console.error('投稿中にエラーが発生しました:', error);
            alert('投稿中にエラーが発生しました。ネットワーク接続を確認してください。');
        }
    });

    // トピック変更フォームの送信イベントリスナー
    topicForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const newTopic = newTopicInput.value;
        const adminSeed = adminPassForTopicInput.value;

        if (!newTopic || !adminSeed) {
            alert('新しいトピックと管理者シードは必須です。');
            return;
        }

        try {
            const response = await fetch('/topic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic: newTopic, pass: adminSeed }), // passを送信
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message);
                newTopicInput.value = '';
                adminPassForTopicInput.value = '';
                await loadPosts(); // トピック更新後、掲示板を再読み込み
            } else {
                alert('トピックの変更に失敗しました: ' + result.error);
            }
        } catch (error) {
            console.error('トピック変更中にエラーが発生しました:', error);
            alert('トピック変更中にエラーが発生しました。ネットワーク接続を確認してください。');
        }
    });

    // ページ読み込み時に掲示板データをロード
    document.addEventListener('DOMContentLoaded', loadPosts);
</script>
</body>
</html>
